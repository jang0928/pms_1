DROP TABLE PR_TASK; -- 프로젝트 테이블 삭제
DELETE FROM PR_TASK;
-- DROP SEQUENCE PR_TASK_NO_SEQ;-- 시퀀스 삭제
ALTER TABLE PR_TASK ADD(PR_STATE VARCHAR2(50)); -- 상태(진행전, 진행중, 완료)

-- ALTER TABLE PR_TASK RENAME COLUMN 기존컬럼명 to 변경컬럼; -- 컬럼명 수정

CREATE TABLE PR_TASK(
	PR_NO NUMBER, -- 프로젝트 번호
	CONSTRAINT FK_PR_TASK_PR_NO FOREIGN KEY (PR_NO)
	REFERENCES PR_PROJECT(PR_NO) ON DELETE CASCADE,
	TS_NO NUMBER, -- 업무 번호
	TS_REFNO NUMBER, -- 상위 업무 번호
	TS_TITLE VARCHAR(200), -- 업무 명
	TS_SDATE VARCHAR(50), -- 업무 시작 일자
	TS_EDATE VARCHAR(50), -- 업무 종료 일자
	TS_EREAL VARCHAR(50), -- 실제 업무 종료 일자
	TS_RATE NUMBER, -- 진행률
	MEM_NO NUMBER, -- 사원번호(개발자)
	CONSTRAINT FK_TS_TASK_MEM_NO FOREIGN KEY (MEM_NO)
	REFERENCES MEMBERS(MEM_NO) ON DELETE SET NULL
);


-- 등록 1
INSERT INTO PR_TASK VALUES(1, 1, 0, '분석설계', '2021-03-22', '2021-03-28', '2021-03-28', 100, 1000);
-- 등록 5 순차적으로
INSERT INTO PR_TASK VALUES(1, 5, 1, '요구사항 정의서', '2021-03-22', '2021-03-25', '2021-03-25', 100, 1001);
INSERT INTO PR_TASK VALUES(1, 6, 1, '일정계획', '2021-03-23', '2021-03-26', '2021-03-26', 100, 1001);
INSERT INTO PR_TASK VALUES(1, 7, 1, 'application설계', '2021-03-24', '2021-03-26', '2021-03-26', 100, 1001);
INSERT INTO PR_TASK VALUES(1, 8, 1, '화면설계', '2021-03-26', '2021-03-28', '2021-03-28', 100, 1001);
-- 등록 2
INSERT INTO PR_TASK VALUES(1, 2, 0, 'front end 개발', '2021-03-29', '2021-04-11', NULL, 0, 1000);
-- 등록 6 순차적으로
INSERT INTO PR_TASK VALUES(1, 9, 2, 'DB 설계', '2021-03-29', '2021-04-07', NULL, 0, 1002);
INSERT INTO PR_TASK VALUES(1, 10, 2, '공통모듈 구현', '2021-03-29', '2021-04-09', NULL, 0, 1002);
INSERT INTO PR_TASK VALUES(1, 11, 2, 'front end단 구현', '2021-03-29', '2021-04-11', NULL, 0, 1002);
-- 동록 3
INSERT INTO PR_TASK VALUES(1, 3, 0, 'back end 개발', '2021-04-12', '2021-04-25', NULL, 0, 1000);
-- 등록 7 순차적으로
INSERT INTO PR_TASK VALUES(1, 12, 3, '스프링 데이터베이스 연동', '2021-04-12', '2021-04-25', NULL, 0, 1003);
-- 등록 4
INSERT INTO PR_TASK VALUES(1, 4, 0, '통합 test 및 배포', '2021-04-26', '2021-04-29', NULL, 0, 1000);
-- 등록 8 순차적으로
INSERT INTO PR_TASK VALUES(1, 13, 4, '통합 test', '2021-04-26', '2021-04-28', NULL, 0, 1004);
INSERT INTO PR_TASK VALUES(1, 14, 4, '배포', '2021-04-28', '2021-04-29', NULL, 0, 1004);

-- 등록 1
INSERT INTO PR_TASK VALUES(2, 1, 0, '분석설계', '2021-03-26', '2021-04-07', NULL, 0, 1005);
-- 등록 5 순차적으로
INSERT INTO PR_TASK VALUES(2, 5, 1, '요구사항 정의서', '2021-03-26', '2021-04-02', NULL, 0, 1006);
INSERT INTO PR_TASK VALUES(2, 6, 1, '일정계획', '2021-03-27', '2021-04-02', NULL, 0, 1006);
INSERT INTO PR_TASK VALUES(2, 7, 1, 'application설계', '2021-03-30', '2021-04-06', NULL, 0, 1006);
INSERT INTO PR_TASK VALUES(2, 8, 1, '화면설계', '2021-03-30', '2021-04-07', NULL, 0, 1006);
-- 등록 2
INSERT INTO PR_TASK VALUES(2, 2, 0, 'front end 개발', '2021-04-08', '2021-04-14', NULL, 0, 1005);
-- 등록 6 순차적으로
INSERT INTO PR_TASK VALUES(2, 9, 2, 'DB 설계', '2021-04-08', '2021-04-12', NULL, 0, 1007);
INSERT INTO PR_TASK VALUES(2, 10, 2, '공통모듈 구현', '2021-04-08', '2021-04-13', NULL, 0, 1007);
INSERT INTO PR_TASK VALUES(2, 11, 2, 'front end단 구현', '2021-04-08', '2021-04-14', NULL, 0, 1007);
-- 등록 3
INSERT INTO PR_TASK VALUES(2, 3, 0, 'back end 개발', '2021-04-15', '2021-04-21', NULL, 0, 1005);
-- 등록 7 순차적으로
INSERT INTO PR_TASK VALUES(2, 12, 3, '스프링 데이터베이스 연동', '2021-04-15', '2021-04-21', NULL, 0, 1008);
-- 등록 4
INSERT INTO PR_TASK VALUES(2, 4, 0, '통합 test 및 배포', '2021-04-22', '2021-04-25', NULL, 0, 1005);
-- 등록 8 순차적으로
INSERT INTO PR_TASK VALUES(2, 13, 4, '통합 test', '2021-04-22', '2021-04-24', NULL, 0, 1009);
INSERT INTO PR_TASK VALUES(2, 14, 4, '배포', '2021-04-24', '2021-04-25', NULL, 0, 1009);

CREATE SEQUENCE PR_TASK_NO_SEQ START WITH 20
MINVALUE 1 MAXVALUE 1000000 CYCLE; 
-- PR_TASK_NO_SEQ.NEXTVAL
SELECT * FROM PR_TASK;
SELECT * FROM PR_PROJECT;

SELECT pp.*, pt.*, m.MEM_NAME 
FROM PR_PROJECT pp, PR_TASK pt, MEMBERS m
WHERE pp.PR_NO = pt.PR_NO AND pt.MEM_NO = m.MEM_NO AND pt.PR_NO = 3 AND pt.TS_NO = 9 AND pt.TS_TITLE = '흠흠';

SELECT * FROM PR_TASK WHERE pr_no = 46 AND TS_REFNO <> 0
ORDER BY TS_REFNO ;
SELECT * FROM PR_TASK WHERE pr_no = 61
ORDER BY TS_REFNO ;
SELECT * FROM PR_PROJECT pp WHERE PR_NO = 61;

-- 특정 프로젝트 조회 계층처리
SELECT *
FROM (
SELECT rownum, LEVEL, pp.PR_NO, pt.TS_NO, pt.TS_REFNO, pt.TS_TITLE, pt.TS_SDATE, pt.TS_EDATE, pt.TS_EREAL, pt.TS_RATE,
      pt.MEM_NO, m.MEM_NAME, pp.PR_TITLE, pp.PR_DATE, pp.PR_SDATE, pp.PR_EDATE, pp.PR_STATE 
FROM PR_TASK pt, MEMBERS m, PR_PROJECT pp
WHERE pt.MEM_NO = m.MEM_NO AND pt.PR_NO = pp.PR_NO AND pp.PR_NO = 1
START WITH pp.PR_NO = 1 AND TS_REFNO = 0
CONNECT BY PRIOR TS_NO = TS_REFNO);

-- 계층구조 적용 sql
SELECT *
FROM (
SELECT rownum, LEVEL, pp.PR_NO, pt.TS_NO, pt.TS_REFNO, pt.TS_TITLE, pt.TS_SDATE, pt.TS_EDATE, pt.TS_EREAL, pt.TS_RATE,
		pt.MEM_NO, m.MEM_NAME, pp.PR_TITLE, pp.PR_DATE, pp.PR_SDATE, pp.PR_EDATE, pp.PR_STATE 
FROM PR_TASK pt, MEMBERS m, PR_PROJECT pp
WHERE pt.MEM_NO = m.MEM_NO AND pt.PR_NO = pp.PR_NO AND pp.PR_NO = 2 AND LEVEL BETWEEN 1 AND 2
START WITH pp.PR_NO = 2 AND TS_REFNO = 0
CONNECT BY PRIOR TS_NO = TS_REFNO);

-- 특정 프로젝트에 참여 인원 조회
SELECT DISTINCT mem_name, m.MEM_NO 
FROM PR_TASK pt, MEMBERS m 
WHERE pt.MEM_NO = m.MEM_NO AND PR_NO = 1
ORDER BY m.MEM_NO; 
SELECT mem_name
FROM PR_TASK pt, MEMBERS m 
WHERE pt.MEM_NO = m.MEM_NO AND PR_NO = 1
GROUP BY mem_name
ORDER BY MEM_NO; 


-- 등록
-- 상위 업무
INSERT INTO PR_TASK VALUES(1, 1, 0, '분석설계', '2021-03-22', '2021-03-28', '2021-03-28', 100, 1001);
-- 하위 업무
INSERT INTO PR_TASK VALUES(1, 2, 1, '요구사항 정의서', '2021-03-22', '2021-03-25', '2021-03-25', 100, 1001);

-- 수정(pm 권한 : 일정, 담당자 수정)
UPDATE PR_TASK
	SET ts_no = 5,
		ts_refno = 1,
		ts_title = '수정',
		ts_rate = 50,
		TS_SDATE = '2021-03-27',
		TS_EDATE = '2021-03-29',
		TS_EREAL = '2021-05-29',
		MEM_NO = 1022
	WHERE PR_NO = 3 AND TS_NO = 20;
-- 원본
UPDATE PR_TASK
	SET TS_SDATE = '2021-03-22',
		TS_EDATE = '2021-03-28',
		TS_EREAL = '2021-03-30',
		MEM_NO = 1001
	WHERE PR_NO = 1 AND TS_NO = 1;

-- 수정(사원 권한 : 진행률 수정) 사용 안함
UPDATE PR_TASK
	SET TS_RATE = 30
	WHERE PR_NO = 1 AND TS_NO = 6 AND MEM_NO = 1002;

-- 특정 프로젝트 참여 개발자 조회
	SELECT DISTINCT mem_name, m.MEM_NO 
		FROM PR_TASK pt, MEMBERS m 
		WHERE pt.MEM_NO = m.MEM_NO AND PR_NO = 1
		ORDER BY m.MEM_NO;
SELECT MEM_NO, MEM_NAME 
FROM MEMBERS
WHERE DEPTNO = 1
ORDER BY MEM_NO;

-- 업무 번호 수정(ts_no>=ts_no)
UPDATE PR_TASK
	SET TS_NO = TS_NO-1
	WHERE PR_NO = 3 AND TS_NO >=11;
INSERT INTO PR_TASK VALUES(1, 5, 1, 'test삽입', '2021-03-22', '2021-03-25', '2021-03-25', 100, 1001);



-- 삭제
DELETE FROM PR_TASK
WHERE PR_NO = 46 AND TS_NO =21 OR TS_REFNO =21; -- 해당 프로젝트에 저장된 업무도 모두 삭제 처리

SELECT SYSDATE 
FROM PR_TASK;



SELECT TS_TITLE, TO_DATE(TS_EDATE) - TO_DATE(TS_SDATE)
FROM PR_TASK pt
WHERE TS_REFNO = 0
ORDER BY TS_NO;
SELECT SUM(SYSDATE - TO_DATE(TS_SDATE)) / SUM(TO_DATE(TS_EDATE) - TO_DATE(TS_SDATE))
FROM PR_TASK pt
WHERE TS_REFNO = 0
GROUP BY PR_NO;
SELECT DECODE(TO_DATE(TS_SDATE), TO_DATE(TS_SDATE)<SYSDATE, TO_DATE(TS_SDATE))
FROM PR_TASK pt;
WHERE TS_REFNO = 0
GROUP BY PR_NO;
SELECT to_char(NVL(TS_SDATE,TO_DATE(SYSDATE,'YYYYMMDD')),'YYYYMMDD') TO_CHAR(SYSDATE,'YYYYMMDD')
FROM PR_TASK pt
WHERE TS_REFNO = 0
GROUP BY PR_NO;

SELECT * FROM PR_PROJECT pp;

   SELECT  DISTINCT p.*, r.* FROM members r ,PR_PROJECT p ,PR_TASK pt 
      WHERE  pt.PR_NO =p.PR_NO AND r.mem_no = 1000
      AND pt.MEM_NO =r.MEM_NO
     ORDER BY p.PR_NO;

-- 담당 프로젝트 조회(사원 조회)
   SELECT  DISTINCT p.*, r.MEM_NAME, r.AUTH, r.DEPTNO  
   FROM members r ,PR_PROJECT p ,PR_TASK pt 
      WHERE pt.PR_NO =p.PR_NO AND r.mem_no = 1001
      AND pt.MEM_NO =r.MEM_NO;
-- pm 프로젝트 조회
	SELECT p.*, r.MEM_NAME, r.AUTH, r.DEPTNO  
	FROM members r ,PR_PROJECT p
	WHERE r.MEM_NO = p.MEM_NO AND r.MEM_NO = 1000;

-- 특정 프로젝트 참여자 조회
	SELECT DISTINCT mem_name, m.MEM_NO, m.AUTH  
		FROM PR_TASK pt, MEMBERS m 
		WHERE pt.MEM_NO = m.MEM_NO AND PR_NO = 1
		ORDER BY m.MEM_NO;

SELECT DISTINCT m.MEM_NO, m.MEM_NAME 
FROM PR_TASK pt, MEMBERS m
WHERE pt.MEM_NO = m.MEM_NO AND PR_NO =3
ORDER BY m.MEM_NO;

-- 상위 업무 조회
SELECT *
FROM PR_TASK
WHERE PR_NO = 3 AND TS_REFNO = 0
ORDER BY TS_NO;

SELECT pt.TS_TITLE
FROM PR_TASK pt
WHERE pt.PR_NO = #{pr_no} AND pt.TS_NO = #{ts_no};
     

SELECT TS_TITLE, TS_SDATE, TS_EDATE 
FROM PR_TASK
WHERE MEM_NO = 1001;

SELECT DISTINCT pp.PR_TITLE, pp.PR_SDATE, pp.PR_EDATE 
FROM PR_TASK pt, PR_PROJECT pp 
WHERE pt.PR_NO = pp.PR_NO AND pt.MEM_NO = 1001;

SELECT * FROM MEMBERS m2 
